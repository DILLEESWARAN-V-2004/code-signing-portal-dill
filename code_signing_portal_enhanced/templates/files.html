{% extends "layout.html" %}
{% block content %}

<h3 class="d-flex justify-content-between align-items-center">
  Files
  <a href="{{ url_for('verify_integrity_page') }}" class="btn btn-info btn-sm">Verify Integrity</a>
</h3>

<!-- Upload -->
<div class="card mb-3 p-3">
  <h5>Upload Files</h5>
  <form action="{{ url_for('files_upload') }}" method="post" enctype="multipart/form-data">
    <input class="form-control" type="file" name="files" multiple required>
    <button class="btn btn-primary mt-2">Upload</button>
  </form>
</div>

<!-- Unsigned Files (Sign Section) -->
<div class="card mb-3 p-3">
  <h5>Pending Uploads (Unsigned)</h5>
  {% set pending = files | selectattr("status", "equalto", "uploaded") | list %}
  {% if pending %}
    <!-- Changed the action to files_page to avoid BuildError -->
    <form method="post" action="{{ url_for('files_page') }}">
      <div class="mb-2">
        <label class="form-label">Select Certificate</label>
        <select name="cert_id" class="form-select" required>
          {% for c in certs %}
            <option value="{{ c._id }}">{{ c.cn }} ({{ c.valid_to }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-2">
        <input class="form-control" name="pfx_password" type="password" placeholder="PFX password" required>
      </div>
      <div class="mb-3">
        {% for f in pending %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="selected_files" value="{{ f.filename }}" checked>
            <label class="form-check-label">{{ f.filename }}</label>
          </div>
        {% endfor %}
      </div>
      <button class="btn btn-success">Sign Selected</button>
    </form>
  {% else %}
    <p class="text-muted">No unsigned files pending.</p>
  {% endif %}
</div>

<!-- Signed Files Table -->
<div class="card mb-3 p-3">
  <h5>Signed Files</h5>
  {% set signed_files = files | selectattr("status", "equalto", "signed") | list %}
  {% if signed_files %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Uploaded By</th>
          <th>Uploaded At</th>
          <th>Checksum Original</th>
          <th>Checksum Signed</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for f in signed_files %}
          <tr>
            <td>{{ f.filename }}</td>
            <td>{{ f.uploader }}</td>
            <td>{{ f.uploaded_at }}</td>
            <td>{{ f.checksum_original[:12] ~ '...' if f.checksum_original else 'N/A' }}</td>
            <td>{{ f.checksum_signed[:12] ~ '...' if f.checksum_signed else 'N/A' }}</td>
            <td>
              <div class="btn-group">
                <a href="{{ url_for('download_upload', filename=f.filename) }}" class="btn btn-sm btn-outline-primary">Download</a>
                <form method="post" action="{{ url_for('files_verify') }}" class="d-inline ms-1">
                  <input type="hidden" name="selected_files" value="{{ f.filename }}">
                  <button type="submit" class="btn btn-sm btn-outline-success">Verify</button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">No signed files yet.</p>
  {% endif %}
</div>

{% endblock %}
